<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' https://www.gstatic.com https://apis.google.com; style-src 'self' https://fonts.googleapis.com; img-src 'self' data: https:; connect-src 'self' https://identitytoolkit.googleapis.com https://securetoken.googleapis.com; frame-src 'none'; font-src 'self' https://fonts.gstatic.com;">
    <title>Sign Up - SolTecSol</title>

    <!-- Preconnect to external resources for performance -->
    <link rel="preconnect" href="https://www.gstatic.com">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Firebase SDK -->
    <!-- Firebase SDK and Security Modules for Signup -->
    <script src="./js/token-manager.js"></script>
    <script src="./js/secure-cookies.js"></script>
    <script type="module" src="./js/firebase-signup.js"></script>

    <!-- Cross-Domain Authentication Client -->
    <script src="./cross-domain-auth-client.js"></script>

    <!-- External CSS Styles -->
    <link rel="stylesheet" href="signup-styles.css">

    <!-- REMOVED: Inline styles extracted to signup-styles.css for CSP compliance -->
    <!-- <style>
        /* Base styles and CSS reset */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #10b981;
            --accent-color: #f59e0b;
            --danger-color: #ef4444;
            --warning-color: #f97316;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --border-color: #e5e7eb;
            --border-focus: #3b82f6;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 2rem;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        /* Header styles */
        .header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 1rem;
        }

        .header p {
            font-size: 1.125rem;
            color: var(--text-secondary);
            margin-bottom: 1rem;
        }

        /* Navigation */
        .nav-link {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 500;
            padding: 0.75rem 0;
            transition: all 0.2s ease;
            margin-bottom: 2rem;
        }

        .nav-link:hover {
            color: var(--primary-hover);
        }

        /* Form Container */
        .form-container {
            background: var(--bg-primary);
            border-radius: 1rem;
            padding: 3rem;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--border-color);
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: all 0.2s ease;
            background: var(--bg-primary);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--border-focus);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-input.error {
            border-color: var(--danger-color);
        }

        .form-input.success {
            border-color: var(--secondary-color);
        }

        /* Button Styles */
        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-primary:disabled {
            background: var(--text-muted);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background: var(--bg-secondary);
        }

        .btn-full {
            width: 100%;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: var(--bg-tertiary);
            border-radius: 0.5rem;
            padding: 0.25rem;
            margin-bottom: 2rem;
        }

        .tab-button {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 0.375rem;
            font-weight: 500;
            transition: all 0.2s ease;
            color: var(--text-secondary);
        }

        .tab-button.active {
            background: var(--bg-primary);
            color: var(--primary-color);
            box-shadow: var(--shadow);
        }

        /* Form Tabs */
        .form-tab {
            display: none;
        }

        .form-tab.active {
            display: block;
        }

        /* Error and Success Messages */
        .message {
            padding: 0.875rem 1rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
            font-size: 0.875rem;
            font-weight: 500;
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--secondary-color);
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message.warning {
            background: rgba(249, 115, 22, 0.1);
            color: var(--warning-color);
            border: 1px solid rgba(249, 115, 22, 0.2);
        }

        /* Field Validation */
        .field-error {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        .field-error.show {
            display: block;
        }

        /* Loading Spinner */
        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid transparent;
            border-radius: 50%;
            border-top-color: currentColor;
            animation: spin 0.8s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Notification styles */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 1rem 1.5rem;
            border-radius: 0.5rem;
            color: white;
            font-weight: 500;
            z-index: 9999;
            box-shadow: var(--shadow-lg);
            animation: slideIn 0.3s ease;
        }

        .notification.success {
            background: var(--secondary-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--primary-color);
        }

        @keyframes slideIn {
            from {
                transform: translateX(-50%) translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }

        /* Language Selector */
        .language-selector {
            position: absolute;
            top: 1rem;
            right: 1rem;
            z-index: 10;
        }

        .language-select {
            padding: 0.5rem;
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            background: var(--bg-primary);
            color: var(--text-primary);
            font-size: 0.875rem;
            cursor: pointer;
        }

        /* Password Strength Indicator */
        .password-strength {
            margin-top: 0.5rem;
            display: none;
        }

        .password-strength.show {
            display: block;
        }

        .strength-bar {
            height: 4px;
            background: var(--bg-tertiary);
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 0.25rem;
        }

        .strength-fill {
            height: 100%;
            border-radius: 2px;
            transition: all 0.3s ease;
            width: 0%;
        }

        .strength-fill.weak {
            background: var(--danger-color);
            width: 25%;
        }

        .strength-fill.fair {
            background: var(--warning-color);
            width: 50%;
        }

        .strength-fill.good {
            background: var(--accent-color);
            width: 75%;
        }

        .strength-fill.strong {
            background: var(--secondary-color);
            width: 100%;
        }

        .strength-text {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .form-container {
                padding: 2rem 1.5rem;
            }

            .header h1 {
                font-size: 2rem;
            }

            .language-selector {
                position: static;
                text-align: center;
                margin-bottom: 1rem;
            }
        }

        /* User info display */
        .user-info {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: var(--bg-secondary);
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            border: 1px solid var(--border-color);
            font-size: 0.875rem;
            color: var(--text-secondary);
            display: none;
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(4px);
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .modal-content h2 {
            padding: 1.5rem 2rem;
            margin: 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
            font-size: 1.5rem;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            flex: 1;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .modal-body h3 {
            margin-top: 1.5rem;
            margin-bottom: 0.75rem;
            font-size: 1.125rem;
        }

        .modal-body p {
            margin-bottom: 1rem;
        }

        .modal-body ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-footer {
            padding: 1.5rem 2rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .checkbox-label input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

    </style> -->
</head>
<body>
    <!-- User info display (for debugging) -->
    <div id="userInfo" class="user-info"></div>

    <!-- Navigation -->
    <a href="https://plyvo.soltecsol.com" class="nav-link">
        <span data-translate="backToApp">Back</span>
    </a>

    <div class="container">

        <!-- Header Section -->
        <div class="header">
            <h1 data-translate="signupTitle">Create Account</h1>
            <p data-translate="signupSubtitle">Join SolTecSol and unlock AI-powered product description generation</p>
        </div>

        <!-- Form Container -->
        <div class="form-container">

            <!-- Messages Area -->
            <div id="messageArea"></div>

            <!-- Sign Up Form -->
            <div id="signupTab">
                <form id="signupForm">
                    <div class="form-group">
                        <label for="signupEmail" class="form-label" data-translate="emailLabel">Email Address</label>
                        <input type="email" id="signupEmail" class="form-input" required data-translate-placeholder="emailPlaceholder" placeholder="Enter your email address">
                        <div class="field-error" id="signupEmailError"></div>
                    </div>

                    <div class="form-group">
                        <label for="signupPassword" class="form-label" data-translate="passwordLabel">Password</label>
                        <input type="password" id="signupPassword" class="form-input" required data-translate-placeholder="passwordPlaceholder" placeholder="Create a strong password">
                        <div class="password-strength" id="passwordStrength">
                            <div class="strength-bar">
                                <div class="strength-fill" id="strengthFill"></div>
                            </div>
                            <div class="strength-text" id="strengthText"></div>
                        </div>
                        <div class="field-error" id="signupPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label for="confirmPassword" class="form-label" data-translate="confirmPasswordLabel">Confirm Password</label>
                        <input type="password" id="confirmPassword" class="form-input" required data-translate-placeholder="confirmPasswordPlaceholder" placeholder="Confirm your password">
                        <div class="field-error" id="confirmPasswordError"></div>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="agreementCheckbox">
                            <span data-translate="agreementText">I agree to the <a href="tos.html" target="_blank" rel="noopener noreferrer">Terms of Service</a> and <a href="gdpr.html" target="_blank" rel="noopener noreferrer">GDPR Policy</a></span>
                        </label>
                    </div>

                    <div class="form-group">
                        <button type="submit" class="btn btn-primary btn-full" id="signupSubmit" disabled>
                            <span id="signupButtonText" data-translate="createAccount">Create Account</span>
                            <span class="loading-spinner" id="signupSpinner"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Plan Choice Modal -->
    <div id="planChoiceModal" class="modal-overlay" style="display: none;">
        <div class="modal-content" style="max-width: 600px;">
            <h2 data-translate="welcomeChoosePlan">Welcome! Choose Your Plan</h2>
            <div class="modal-body">
                <p data-translate="emailVerifiedSuccess">Your email has been verified successfully! Now choose how you'd like to get started:</p>

                <div style="display: grid; gap: 1.5rem; margin-top: 2rem;">
                    <!-- Trial Option -->
                    <div class="plan-option" style="border: 2px solid var(--primary-color); border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onclick="chooseTrial()">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--primary-color);" data-translate="freeTrialTitle">üéØ Start Free Trial</h3>
                        <p style="margin: 0 0 1rem 0; color: var(--text-secondary);" data-translate="freeTrialDesc">Try Plyvo with 3 free AI-generated product descriptions. No credit card required.</p>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">
                            <li data-translate="trial3Descriptions">3 AI-generated descriptions</li>
                            <li data-translate="trialAllFeatures">Access to all features</li>
                            <li data-translate="trialNoCard">No credit card needed</li>
                        </ul>
                        <button type="button" class="btn btn-primary btn-full" style="margin-top: 1rem;" data-translate="startTrialButton">Start Free Trial</button>
                    </div>

                    <!-- Subscribe Option -->
                    <div class="plan-option" style="border: 2px solid var(--secondary-color); border-radius: 0.75rem; padding: 1.5rem; cursor: pointer; transition: all 0.2s;" onclick="chooseSubscribe()">
                        <h3 style="margin: 0 0 0.5rem 0; color: var(--secondary-color);" data-translate="subscribeTitle">‚≠ê Subscribe Now</h3>
                        <p style="margin: 0 0 1rem 0; color: var(--text-secondary);" data-translate="subscribeDesc">Get unlimited descriptions with our flexible pricing plans starting at just $9.99/month.</p>
                        <ul style="margin: 0; padding-left: 1.5rem; color: var(--text-primary);">
                            <li data-translate="subscribeUnlimited">Unlimited AI descriptions</li>
                            <li data-translate="subscribePriority">Priority support</li>
                            <li data-translate="subscribeAdvanced">Advanced features</li>
                        </ul>
                        <button type="button" class="btn btn-secondary btn-full" style="margin-top: 1rem; background: var(--secondary-color); color: white;" data-translate="viewPlansButton">View Plans & Subscribe</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Core JavaScript Infrastructure -->
    <!-- Language System -->
    <script src="language-shared.js"></script>
    <script src="plyvo.js"></script>

    <!-- External JavaScript Application -->
    <script src="signup-app.js"></script>

    <!-- REMOVED: Inline JavaScript extracted to signup-app.js for CSP compliance -->
    <!--  <script>
        // SECURITY ENHANCEMENT: Centralized Firebase token management
        class FirebaseTokenManager {
            constructor() {
                this.currentToken = null;
                this.tokenRefreshThreshold = 300000; // 5 minutes before expiry
                this.refreshTimer = null;
                this.tokenListeners = new Set();
            }

            // Get current valid token, refreshing if needed
            async getValidToken() {
                try {
                    const auth = window.firebaseAuth;
                    if (!auth || !auth.currentUser) {
                        this.clearToken();
                        return null;
                    }

                    // Get token with force refresh if close to expiry
                    const forceRefresh = this.shouldForceRefresh();
                    const token = await auth.currentUser.getIdToken(forceRefresh);

                    this.currentToken = token;
                    this.scheduleTokenRefresh();
                    this.notifyTokenListeners(token);

                    return token;

                } catch (error) {
                    console.error('Token refresh failed:', error);
                    this.clearToken();
                    throw error;
                }
            }

            // Check if token should be force refreshed
            shouldForceRefresh() {
                if (!this.currentToken) return true;

                try {
                    const payload = JSON.parse(atob(this.currentToken.split('.')[1]));
                    const expiry = payload.exp * 1000;
                    const timeToExpiry = expiry - Date.now();

                    return timeToExpiry < this.tokenRefreshThreshold;
                } catch (error) {
                    console.warn('Token validation failed:', error);
                    return true;
                }
            }

            // Schedule automatic token refresh
            scheduleTokenRefresh() {
                if (this.refreshTimer) {
                    clearTimeout(this.refreshTimer);
                }

                if (!this.currentToken) return;

                try {
                    const payload = JSON.parse(atob(this.currentToken.split('.')[1]));
                    const expiry = payload.exp * 1000;
                    const refreshTime = expiry - Date.now() - this.tokenRefreshThreshold;

                    if (refreshTime > 0) {
                        this.refreshTimer = setTimeout(() => {
                            this.getValidToken().catch(error => {
                                console.error('Scheduled token refresh failed:', error);
                            });
                        }, refreshTime);
                    }
                } catch (error) {
                    console.warn('Token refresh scheduling failed:', error);
                }
            }

            // Clear cached token and timers
            clearToken() {
                this.currentToken = null;
                if (this.refreshTimer) {
                    clearTimeout(this.refreshTimer);
                    this.refreshTimer = null;
                }
                this.notifyTokenListeners(null);
            }

            // Add token change listener
            addTokenListener(callback) {
                this.tokenListeners.add(callback);
            }

            // Remove token change listener
            removeTokenListener(callback) {
                this.tokenListeners.delete(callback);
            }

            // Notify all listeners of token changes
            notifyTokenListeners(token) {
                this.tokenListeners.forEach(callback => {
                    try {
                        callback(token);
                    } catch (error) {
                        console.error('Token listener error:', error);
                    }
                });
            }
        }

        // SECURITY ENHANCEMENT: Secure Cookie Manager for enhanced security
        class SecureCookieManager {
            constructor() {
                this.cookieSettings = {
                    secure: true,
                    sameSite: 'Strict',
                    httpOnly: false, // Can't be httpOnly for client-side access
                    maxAge: 3600 // 1 hour
                };
            }

            // Set a secure cookie with enhanced security settings
            setCookie(name, value, options = {}) {
                try {
                    const settings = { ...this.cookieSettings, ...options };
                    let cookieString = `${encodeURIComponent(name)}=${encodeURIComponent(value)}`;

                    if (settings.maxAge) {
                        cookieString += `; Max-Age=${settings.maxAge}`;
                    }

                    if (settings.path) {
                        cookieString += `; Path=${settings.path}`;
                    }

                    if (settings.domain) {
                        cookieString += `; Domain=${settings.domain}`;
                    }

                    if (settings.secure && window.location.protocol === 'https:') {
                        cookieString += '; Secure';
                    }

                    if (settings.sameSite) {
                        cookieString += `; SameSite=${settings.sameSite}`;
                    }

                    document.cookie = cookieString;
                    return true;

                } catch (error) {
                    console.error('Failed to set secure cookie:', error);
                    return false;
                }
            }

            // Get cookie value
            getCookie(name) {
                try {
                    const encodedName = encodeURIComponent(name);
                    const cookies = document.cookie.split(';');

                    for (const cookie of cookies) {
                        const [cookieName, cookieValue] = cookie.trim().split('=');
                        if (cookieName === encodedName) {
                            return decodeURIComponent(cookieValue);
                        }
                    }

                    return null;

                } catch (error) {
                    console.error('Failed to get cookie:', error);
                    return null;
                }
            }

            // Delete cookie
            deleteCookie(name, options = {}) {
                try {
                    const settings = { ...options, maxAge: 0, expires: 'Thu, 01 Jan 1970 00:00:00 UTC' };
                    this.setCookie(name, '', settings);
                    return true;

                } catch (error) {
                    console.error('Failed to delete cookie:', error);
                    return false;
                }
            }

            // Initialize secure cookies for authenticated sessions
            async initializeSecureCookies() {
                try {
                    const auth = window.firebaseAuth;
                    if (!auth || !auth.currentUser) {
                        console.log('No authenticated user for cookie initialization');
                        return false;
                    }

                    // Get fresh Firebase token
                    const token = await window.tokenManager.getValidToken();
                    if (!token) {
                        throw new Error('Failed to get valid authentication token');
                    }

                    // Set authentication cookie
                    const authSuccess = this.setCookie('soltecsol_auth_token', token, {
                        path: '/',
                        maxAge: 3600,
                        secure: window.location.protocol === 'https:',
                        sameSite: 'Strict'
                    });

                    // Generate and set CSRF token
                    const csrfToken = this.generateCSRFToken();
                    const csrfSuccess = this.setCookie('soltecsol_csrf_token', csrfToken, {
                        path: '/',
                        maxAge: 3600,
                        secure: window.location.protocol === 'https:',
                        sameSite: 'Strict'
                    });

                    // Set session identifier
                    const sessionId = this.generateSessionId();
                    const sessionSuccess = this.setCookie('soltecsol_session_id', sessionId, {
                        path: '/',
                        maxAge: 3600,
                        secure: window.location.protocol === 'https:',
                        sameSite: 'Strict'
                    });

                    const allSuccess = authSuccess && csrfSuccess && sessionSuccess;
                    console.log(`Secure cookies initialized: ${allSuccess ? 'SUCCESS' : 'PARTIAL/FAILED'}`);

                    return allSuccess;

                } catch (error) {
                    console.error('Secure cookie initialization failed:', error);
                    return false;
                }
            }

            // Generate CSRF token
            generateCSRFToken() {
                const array = new Uint8Array(32);
                window.crypto.getRandomValues(array);
                return Array.from(array, byte => byte.toString(16).padStart(2, '0')).join('');
            }

            // Generate session identifier
            generateSessionId() {
                const timestamp = Date.now().toString(36);
                const randomBytes = new Uint8Array(16);
                window.crypto.getRandomValues(randomBytes);
                const randomString = Array.from(randomBytes, byte => byte.toString(36)).join('');
                return `${timestamp}_${randomString}`;
            }

            // Clear all authentication-related cookies
            clearAllCookies() {
                try {
                    this.deleteCookie('soltecsol_auth_token', { path: '/' });
                    this.deleteCookie('soltecsol_csrf_token', { path: '/' });
                    this.deleteCookie('soltecsol_session_id', { path: '/' });
                    console.log('All secure cookies cleared');
                    return true;

                } catch (error) {
                    console.error('Failed to clear secure cookies:', error);
                    return false;
                }
            }
        }

        // Global instances
        window.tokenManager = new FirebaseTokenManager();
        window.secureCookieManager = new SecureCookieManager();

        // Initialize token management with automatic refresh monitoring
        function initializeTokenManager() {
            const auth = window.firebaseAuth;
            if (!auth) {
                console.warn('Firebase Auth not available for token management');
                return;
            }

            // Monitor authentication state changes
            auth.onAuthStateChanged(async (user) => {
                if (user) {
                    console.log('User authenticated - initializing token management');
                    try {
                        await window.tokenManager.getValidToken();

                        // Initialize secure cookies for authenticated user
                        try {
                            await window.secureCookieManager.initializeSecureCookies();
                        } catch (error) {
                            console.error('Failed to initialize secure cookies for authenticated user:', error);
                        }

                        // Update user info display
                        updateUserInfo();

                        // Redirect to app on successful authentication with secure return URL handling
                        if (user.emailVerified) {
                            showNotification('Sign in successful! Redirecting...', 'success');
                            setTimeout(() => {
                                // Get and validate return URL securely
                                const validatedReturnUrl = getValidatedReturnUrl();

                                // Clear stored return URL before redirect
                                sessionStorage.removeItem('auth_return_url');
                                window.location.href = validatedReturnUrl;
                            }, 2000);
                        } else {
                            showMessage('Please verify your email address before continuing.', 'warning');
                        }
                    } catch (error) {
                        console.error('Token management initialization failed:', error);
                    }
                } else {
                    console.log('User signed out - clearing token cache and cookies');
                    window.tokenManager.clearToken();
                    window.secureCookieManager.clearAllCookies();
                    updateUserInfo();
                }
            });

            // Monitor token refresh events
            auth.onIdTokenChanged(async (user) => {
                if (user) {
                    try {
                        await window.tokenManager.getValidToken();
                    } catch (error) {
                        console.error('Token refresh monitoring failed:', error);
                    }
                }
            });
        }

        // Notification system for user feedback
        function showNotification(message, type = 'success') {
            // Remove existing notification if any
            const existingNotification = document.querySelector('.notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // Create new notification
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;

            document.body.appendChild(notification);

            // Auto-remove after 5 seconds
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 5000);
        }

        // Show form messages
        function showMessage(message, type = 'info') {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // Clear form messages
        function clearMessage() {
            const messageArea = document.getElementById('messageArea');
            messageArea.innerHTML = '';
        }

        // Field validation functions
        function showFieldError(fieldId, message) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);

            if (errorElement && inputElement) {
                errorElement.textContent = message;
                errorElement.classList.add('show');
                inputElement.classList.add('error');
                inputElement.classList.remove('success');
            }
        }

        function clearFieldError(fieldId) {
            const errorElement = document.getElementById(fieldId + 'Error');
            const inputElement = document.getElementById(fieldId);

            if (errorElement && inputElement) {
                errorElement.classList.remove('show');
                inputElement.classList.remove('error');
            }
        }

        function showFieldSuccess(fieldId) {
            const inputElement = document.getElementById(fieldId);
            if (inputElement) {
                inputElement.classList.add('success');
                inputElement.classList.remove('error');
            }
        }

        // Email validation
        function validateEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // Password strength validation
        function validatePasswordStrength(password) {
            const checks = {
                length: password.length >= 8,
                uppercase: /[A-Z]/.test(password),
                lowercase: /[a-z]/.test(password),
                number: /\d/.test(password),
                special: /[!@#$%^&*(),.?":{}|<>]/.test(password)
            };

            const passedChecks = Object.values(checks).filter(Boolean).length;

            let strength = 'weak';
            if (passedChecks >= 4) strength = 'strong';
            else if (passedChecks >= 3) strength = 'good';
            else if (passedChecks >= 2) strength = 'fair';

            return { strength, checks, score: passedChecks };
        }

        // Update password strength indicator
        function updatePasswordStrength(password) {
            const strengthIndicator = document.getElementById('passwordStrength');
            const strengthFill = document.getElementById('strengthFill');
            const strengthText = document.getElementById('strengthText');

            if (!password) {
                strengthIndicator.classList.remove('show');
                return;
            }

            const result = validatePasswordStrength(password);
            strengthIndicator.classList.add('show');

            // Update strength bar
            strengthFill.className = `strength-fill ${result.strength}`;

            // Update strength text
            const strengthLabels = {
                weak: translations[currentLanguage]?.passwordWeak || 'Weak',
                fair: translations[currentLanguage]?.passwordFair || 'Fair',
                good: translations[currentLanguage]?.passwordGood || 'Good',
                strong: translations[currentLanguage]?.passwordStrong || 'Strong'
            };

            strengthText.textContent = strengthLabels[result.strength];
        }

        // No tab switching needed - signup only page

        // Modal Management
        let signupData = null; // Store signup data temporarily

        // Anti-Abuse System: IP Tracking + Disposable Email Blocking + Signup Cookie
        // NOTE: Cookies only prevent NEW signups, not sign-ins (users can login from any device)
        class AntiAbuseSystem {
            constructor() {
                this.ipAddress = null;
            }

            // Get user's IP address for logging
            async getIPAddress() {
                try {
                    // Use serverless function to get IP
                    const response = await fetch('/.netlify/functions/get-client-ip');
                    const data = await response.json();
                    this.ipAddress = data.ip;
                    return this.ipAddress;
                } catch (error) {
                    console.error('Failed to get IP address:', error);
                    // Fallback: use a third-party service
                    try {
                        const fallbackResponse = await fetch('https://api.ipify.org?format=json');
                        const fallbackData = await fallbackResponse.json();
                        this.ipAddress = fallbackData.ip;
                        return this.ipAddress;
                    } catch (fallbackError) {
                        console.error('Fallback IP fetch failed:', fallbackError);
                        return null;
                    }
                }
            }

            // Check if device already used for signup
            async checkForAbuse(email) {
                try {
                    // Get IP address for logging
                    const ipAddress = await this.getIPAddress();

                    // Check if cookie exists (device already used for signup)
                    if (this.hasSignupCookie()) {
                        return {
                            blocked: true,
                            reason: 'signup_already_used',
                            message: 'This device has already been used to create an account. Please sign in instead.'
                        };
                    }

                    // TODO: Check Firestore for IP abuse patterns (server-side)
                    // For now, return the IP to be stored with user account
                    return {
                        blocked: false,
                        ipAddress: ipAddress
                    };

                } catch (error) {
                    console.error('Anti-abuse check failed:', error);
                    // Allow signup if check fails (don't block legitimate users)
                    return { blocked: false };
                }
            }

            // Set persistent cookie after successful signup
            setSignupCookie() {
                // Cookie expires in 1 year
                const expiryDate = new Date();
                expiryDate.setFullYear(expiryDate.getFullYear() + 1);
                const timestamp = new Date().getTime();

                document.cookie = `soltecsol_signup_used=${timestamp}; expires=${expiryDate.toUTCString()}; path=/; secure; samesite=strict`;
            }

            // Check if signup cookie exists
            hasSignupCookie() {
                return document.cookie.includes('soltecsol_signup_used=');
            }

            // Block disposable email domains
            isDisposableEmail(email) {
                const disposableDomains = [
                    'tempmail.com', '10minutemail.com', 'guerrillamail.com', 'mailinator.com',
                    'throwaway.email', 'temp-mail.org', 'fakeinbox.com', 'trashmail.com',
                    'yopmail.com', 'maildrop.cc', 'sharklasers.com', 'getnada.com',
                    'tempr.email', 'dispostable.com', 'emailondeck.com', 'mohmal.com'
                ];

                const emailDomain = email.toLowerCase().split('@')[1];
                return disposableDomains.includes(emailDomain);
            }
        }

        // Initialize anti-abuse system
        const antiAbuse = new AntiAbuseSystem();

        // Load ToS content
        async function loadTosContent() {
            try {
                const response = await fetch('tos.html');
                const html = await response.text();

                // Extract body content from tos.html
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const body = doc.body;

                document.getElementById('tosContent').innerHTML = body.innerHTML || '<p>Terms of Service content</p>';
            } catch (error) {
                console.error('Failed to load ToS:', error);
                document.getElementById('tosContent').innerHTML = '<p>Failed to load Terms of Service. Please contact support.</p>';
            }
        }

        // Load DPA content
        async function loadDpaContent() {
            try {
                const response = await fetch('dpa.html');
                const html = await response.text();

                // Extract body content from dpa.html
                const parser = new DOMParser();
                const doc = parser.parseFromString(html, 'text/html');
                const body = doc.body;

                document.getElementById('dpaContent').innerHTML = body.innerHTML || '<p>Data Protection Agreement content</p>';
            } catch (error) {
                console.error('Failed to load DPA:', error);
                document.getElementById('dpaContent').innerHTML = '<p>Failed to load Data Protection Agreement. Please contact support.</p>';
            }
        }

        // Show ToS Modal
        function showTosModal() {
            const modal = document.getElementById('tosModal');
            modal.style.display = 'flex';
            loadTosContent();
        }

        // Hide ToS Modal
        function hideTosModal() {
            const modal = document.getElementById('tosModal');
            modal.style.display = 'none';
        }

        // Show DPA Modal
        function showDpaModal() {
            const modal = document.getElementById('dpaModal');
            modal.style.display = 'flex';
            loadDpaContent();
        }

        // Hide DPA Modal
        function hideDpaModal() {
            const modal = document.getElementById('dpaModal');
            modal.style.display = 'none';
        }

        // Setup ToS checkbox handler
        function setupTosCheckbox() {
            const checkbox = document.getElementById('tosCheckbox');
            const continueBtn = document.getElementById('tosContinue');

            checkbox.addEventListener('change', () => {
                continueBtn.disabled = !checkbox.checked;
            });

            continueBtn.addEventListener('click', () => {
                if (checkbox.checked) {
                    hideTosModal();
                    showDpaModal();
                }
            });
        }

        // Setup DPA checkbox handler
        function setupDpaCheckbox() {
            const checkbox = document.getElementById('dpaCheckbox');
            const submitBtn = document.getElementById('dpaSubmit');

            checkbox.addEventListener('change', () => {
                submitBtn.disabled = !checkbox.checked;
            });

            submitBtn.addEventListener('click', async () => {
                if (checkbox.checked && signupData) {
                    hideDpaModal();
                    // Now proceed with actual Firebase signup
                    await createFirebaseAccount(signupData);
                }
            });
        }

        // Create Firebase account after both modals accepted
        async function createFirebaseAccount(data) {
            const { email, password } = data;

            const submitBtn = document.getElementById('signupSubmit');
            const buttonText = document.getElementById('signupButtonText');
            const spinner = document.getElementById('signupSpinner');

            try {
                // Show loading state
                submitBtn.disabled = true;
                buttonText.style.display = 'none';
                spinner.style.display = 'inline-block';

                // Create user with Firebase
                const userCredential = await window.firebaseCreateUserWithEmailAndPassword(window.firebaseAuth, email, password);
                const user = userCredential.user;

                // Send email verification
                await window.firebaseSendEmailVerification(user);

                // Set signup cookie to prevent repeat signups from this device
                antiAbuse.setSignupCookie();

                showMessage(translations[currentLanguage]?.verificationEmailSent || 'Account created! Please check your email to verify your account.', 'success');

                // Reset form
                document.getElementById('signupForm').reset();
                document.getElementById('passwordStrength').classList.remove('show');
                signupData = null;

            } catch (error) {
                console.error('Sign up error:', error);

                let errorMessage = translations[currentLanguage]?.signupError || 'Failed to create account. Please try again.';

                switch (error.code) {
                    case 'auth/email-already-in-use':
                        errorMessage = translations[currentLanguage]?.emailInUse || 'Email address is already in use';
                        showFieldError('signupEmail', errorMessage);
                        break;
                    case 'auth/weak-password':
                        errorMessage = translations[currentLanguage]?.passwordWeak || 'Password is too weak';
                        showFieldError('signupPassword', errorMessage);
                        break;
                    case 'auth/invalid-email':
                        errorMessage = translations[currentLanguage]?.emailInvalid || 'Invalid email address';
                        showFieldError('signupEmail', errorMessage);
                        break;
                    default:
                        showMessage(errorMessage, 'error');
                }

            } finally {
                // Reset loading state
                submitBtn.disabled = false;
                buttonText.style.display = 'inline';
                spinner.style.display = 'none';
            }
        }

        // Sign up form handler - now shows ToS modal instead of direct signup
        async function handleSignUp(event) {
            event.preventDefault();

            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            // Clear previous errors
            clearMessage();
            clearFieldError('signupEmail');
            clearFieldError('signupPassword');
            clearFieldError('confirmPassword');

            let isValid = true;

            // Validate email
            if (!email) {
                showFieldError('signupEmail', translations[currentLanguage]?.emailRequired || 'Email is required');
                isValid = false;
            } else if (!validateEmail(email)) {
                showFieldError('signupEmail', translations[currentLanguage]?.emailInvalid || 'Please enter a valid email address');
                isValid = false;
            } else if (antiAbuse.isDisposableEmail(email)) {
                showFieldError('signupEmail', 'Disposable email addresses are not allowed. Please use a permanent email address.');
                isValid = false;
            } else {
                showFieldSuccess('signupEmail');
            }

            // Validate password
            if (!password) {
                showFieldError('signupPassword', translations[currentLanguage]?.passwordRequired || 'Password is required');
                isValid = false;
            } else {
                const strengthResult = validatePasswordStrength(password);
                if (strengthResult.score < 3) {
                    showFieldError('signupPassword', translations[currentLanguage]?.passwordWeak || 'Password is too weak');
                    isValid = false;
                } else {
                    showFieldSuccess('signupPassword');
                }
            }

            // Validate password confirmation
            if (!confirmPassword) {
                showFieldError('confirmPassword', translations[currentLanguage]?.confirmPasswordRequired || 'Please confirm your password');
                isValid = false;
            } else if (password !== confirmPassword) {
                showFieldError('confirmPassword', translations[currentLanguage]?.passwordMismatch || 'Passwords do not match');
                isValid = false;
            } else {
                showFieldSuccess('confirmPassword');
            }

            if (!isValid) {
                return;
            }

            // Anti-abuse check
            const abuseCheck = await antiAbuse.checkForAbuse(email);
            if (abuseCheck.blocked) {
                showMessage(abuseCheck.message, 'error');
                return;
            }

            // Store signup data temporarily (including IP for Firestore)
            signupData = {
                email,
                password,
                ipAddress: abuseCheck.ipAddress
            };

            // Show ToS modal instead of creating account directly
            showTosModal();
        }

        // Sign in moved to login.html - signup page is signup-only

        // Update user info display
        function updateUserInfo() {
            try {
                const auth = window.firebaseAuth;
                const userInfoDiv = document.getElementById('userInfo');

                if (auth && auth.currentUser && userInfoDiv) {
                    const user = auth.currentUser;
                    userInfoDiv.innerHTML = `
                        <strong>User:</strong> ${user.email}
                        ${user.emailVerified ? '‚úì' : '‚ùå'}
                        <span style="margin-left: 0.5rem; font-size: 0.75rem;">${user.uid.substring(0, 8)}</span>
                    `;
                    userInfoDiv.style.display = 'block';
                } else if (userInfoDiv) {
                    userInfoDiv.style.display = 'none';
                }
            } catch (error) {
                console.error('Failed to update user info:', error);
            }
        }

        // Internationalization framework with 6 languages
        const translations = {
            en: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Create Account',
                signupSubtitle: 'Join SolTecSol and unlock AI-powered product description generation',
                backToApp: 'Back to App',

                // Navigation
                signUp: 'Sign Up',
                signIn: 'Sign In',

                // Form labels
                emailLabel: 'Email Address',
                passwordLabel: 'Password',
                confirmPasswordLabel: 'Confirm Password',

                // Placeholders
                emailPlaceholder: 'Enter your email address',
                passwordPlaceholder: 'Create a strong password',
                confirmPasswordPlaceholder: 'Confirm your password',
                signinPasswordPlaceholder: 'Enter your password',

                // Buttons
                createAccount: 'Create Account',
                signInButton: 'Sign In',
                forgotPassword: 'Forgot Password?',

                // Validation messages
                emailRequired: 'Email is required',
                emailInvalid: 'Please enter a valid email address',
                emailInUse: 'Email address is already in use',
                emailNotFound: 'No account found with this email address',
                passwordRequired: 'Password is required',
                confirmPasswordRequired: 'Please confirm your password',
                passwordMismatch: 'Passwords do not match',
                passwordWeak: 'Weak',
                passwordFair: 'Fair',
                passwordGood: 'Good',
                passwordStrong: 'Strong',

                // Status messages
                verificationEmailSent: 'Account created! Please check your email to verify your account.',
                emailNotVerified: 'Please verify your email address before signing in.',
                passwordResetSent: 'Password reset email sent. Please check your inbox.',
                signinSuccess: 'Sign in successful! Redirecting...',

                // Error messages
                signupError: 'Failed to create account. Please try again.',
                signinError: 'Failed to sign in. Please try again.',
                passwordResetError: 'Failed to send password reset email.',
                invalidCredentials: 'Invalid email or password',
                accountDisabled: 'This account has been disabled',
                tooManyRequests: 'Too many failed attempts. Please try again later'
            },
            es: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Crear Cuenta',
                signupSubtitle: '√önete a SolTecSol y desbloquea la generaci√≥n de descripciones de productos con IA',
                backToApp: 'Volver a la App',

                // Navigation
                signUp: 'Registrarse',
                signIn: 'Iniciar Sesi√≥n',

                // Form labels
                emailLabel: 'Direcci√≥n de Email',
                passwordLabel: 'Contrase√±a',
                confirmPasswordLabel: 'Confirmar Contrase√±a',

                // Placeholders
                emailPlaceholder: 'Ingresa tu direcci√≥n de email',
                passwordPlaceholder: 'Crea una contrase√±a segura',
                confirmPasswordPlaceholder: 'Confirma tu contrase√±a',
                signinPasswordPlaceholder: 'Ingresa tu contrase√±a',

                // Buttons
                createAccount: 'Crear Cuenta',
                signInButton: 'Iniciar Sesi√≥n',
                forgotPassword: '¬øOlvidaste la contrase√±a?',

                // Validation messages
                emailRequired: 'El email es requerido',
                emailInvalid: 'Por favor ingresa una direcci√≥n de email v√°lida',
                emailInUse: 'La direcci√≥n de email ya est√° en uso',
                emailNotFound: 'No se encontr√≥ ninguna cuenta con esta direcci√≥n de email',
                passwordRequired: 'La contrase√±a es requerida',
                confirmPasswordRequired: 'Por favor confirma tu contrase√±a',
                passwordMismatch: 'Las contrase√±as no coinciden',
                passwordWeak: 'D√©bil',
                passwordFair: 'Regular',
                passwordGood: 'Buena',
                passwordStrong: 'Fuerte',

                // Status messages
                verificationEmailSent: '¬°Cuenta creada! Por favor revisa tu email para verificar tu cuenta.',
                emailNotVerified: 'Por favor verifica tu direcci√≥n de email antes de iniciar sesi√≥n.',
                passwordResetSent: 'Email de restablecimiento de contrase√±a enviado. Por favor revisa tu bandeja de entrada.',
                signinSuccess: '¬°Inicio de sesi√≥n exitoso! Redirigiendo...',

                // Error messages
                signupError: 'Error al crear la cuenta. Por favor intenta de nuevo.',
                signinError: 'Error al iniciar sesi√≥n. Por favor intenta de nuevo.',
                passwordResetError: 'Error al enviar el email de restablecimiento de contrase√±a.',
                invalidCredentials: 'Email o contrase√±a inv√°lidos',
                accountDisabled: 'Esta cuenta ha sido deshabilitada',
                tooManyRequests: 'Demasiados intentos fallidos. Por favor intenta de nuevo m√°s tarde'
            },
            fr: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Cr√©er un Compte',
                signupSubtitle: 'Rejoignez SolTecSol et d√©bloquez la g√©n√©ration de descriptions de produits aliment√©e par l\'IA',
                backToApp: 'Retour √† l\'App',

                // Navigation
                signUp: 'S\'inscrire',
                signIn: 'Se Connecter',

                // Form labels
                emailLabel: 'Adresse Email',
                passwordLabel: 'Mot de Passe',
                confirmPasswordLabel: 'Confirmer le Mot de Passe',

                // Placeholders
                emailPlaceholder: 'Entrez votre adresse email',
                passwordPlaceholder: 'Cr√©ez un mot de passe fort',
                confirmPasswordPlaceholder: 'Confirmez votre mot de passe',
                signinPasswordPlaceholder: 'Entrez votre mot de passe',

                // Buttons
                createAccount: 'Cr√©er un Compte',
                signInButton: 'Se Connecter',
                forgotPassword: 'Mot de passe oubli√©?',

                // Validation messages
                emailRequired: 'L\'email est requis',
                emailInvalid: 'Veuillez entrer une adresse email valide',
                emailInUse: 'L\'adresse email est d√©j√† utilis√©e',
                emailNotFound: 'Aucun compte trouv√© avec cette adresse email',
                passwordRequired: 'Le mot de passe est requis',
                confirmPasswordRequired: 'Veuillez confirmer votre mot de passe',
                passwordMismatch: 'Les mots de passe ne correspondent pas',
                passwordWeak: 'Faible',
                passwordFair: 'Correct',
                passwordGood: 'Bon',
                passwordStrong: 'Fort',

                // Status messages
                verificationEmailSent: 'Compte cr√©√©! Veuillez v√©rifier votre email pour v√©rifier votre compte.',
                emailNotVerified: 'Veuillez v√©rifier votre adresse email avant de vous connecter.',
                passwordResetSent: 'Email de r√©initialisation du mot de passe envoy√©. Veuillez v√©rifier votre bo√Æte de r√©ception.',
                signinSuccess: 'Connexion r√©ussie! Redirection...',

                // Error messages
                signupError: '√âchec de la cr√©ation du compte. Veuillez r√©essayer.',
                signinError: '√âchec de la connexion. Veuillez r√©essayer.',
                passwordResetError: '√âchec de l\'envoi de l\'email de r√©initialisation du mot de passe.',
                invalidCredentials: 'Email ou mot de passe invalide',
                accountDisabled: 'Ce compte a √©t√© d√©sactiv√©',
                tooManyRequests: 'Trop de tentatives √©chou√©es. Veuillez r√©essayer plus tard'
            },
            de: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Konto Erstellen',
                signupSubtitle: 'Treten Sie SolTecSol bei und schalten Sie KI-gest√ºtzte Produktbeschreibungsgenerierung frei',
                backToApp: 'Zur√ºck zur App',

                // Navigation
                signUp: 'Registrieren',
                signIn: 'Anmelden',

                // Form labels
                emailLabel: 'E-Mail-Adresse',
                passwordLabel: 'Passwort',
                confirmPasswordLabel: 'Passwort Best√§tigen',

                // Placeholders
                emailPlaceholder: 'Geben Sie Ihre E-Mail-Adresse ein',
                passwordPlaceholder: 'Erstellen Sie ein sicheres Passwort',
                confirmPasswordPlaceholder: 'Best√§tigen Sie Ihr Passwort',
                signinPasswordPlaceholder: 'Geben Sie Ihr Passwort ein',

                // Buttons
                createAccount: 'Konto Erstellen',
                signInButton: 'Anmelden',
                forgotPassword: 'Passwort vergessen?',

                // Validation messages
                emailRequired: 'E-Mail ist erforderlich',
                emailInvalid: 'Bitte geben Sie eine g√ºltige E-Mail-Adresse ein',
                emailInUse: 'E-Mail-Adresse wird bereits verwendet',
                emailNotFound: 'Kein Konto mit dieser E-Mail-Adresse gefunden',
                passwordRequired: 'Passwort ist erforderlich',
                confirmPasswordRequired: 'Bitte best√§tigen Sie Ihr Passwort',
                passwordMismatch: 'Passw√∂rter stimmen nicht √ºberein',
                passwordWeak: 'Schwach',
                passwordFair: 'Angemessen',
                passwordGood: 'Gut',
                passwordStrong: 'Stark',

                // Status messages
                verificationEmailSent: 'Konto erstellt! Bitte √ºberpr√ºfen Sie Ihre E-Mail, um Ihr Konto zu verifizieren.',
                emailNotVerified: 'Bitte verifizieren Sie Ihre E-Mail-Adresse bevor Sie sich anmelden.',
                passwordResetSent: 'Passwort-Reset-E-Mail gesendet. Bitte √ºberpr√ºfen Sie Ihren Posteingang.',
                signinSuccess: 'Anmeldung erfolgreich! Weiterleitung...',

                // Error messages
                signupError: 'Fehler beim Erstellen des Kontos. Bitte versuchen Sie es erneut.',
                signinError: 'Fehler beim Anmelden. Bitte versuchen Sie es erneut.',
                passwordResetError: 'Fehler beim Senden der Passwort-Reset-E-Mail.',
                invalidCredentials: 'Ung√ºltige E-Mail oder Passwort',
                accountDisabled: 'Dieses Konto wurde deaktiviert',
                tooManyRequests: 'Zu viele fehlgeschlagene Versuche. Bitte versuchen Sie es sp√§ter erneut'
            },
            it: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Crea Account',
                signupSubtitle: 'Unisciti a SolTecSol e sblocca la generazione di descrizioni prodotto alimentata dall\'IA',
                backToApp: 'Torna all\'App',

                // Navigation
                signUp: 'Registrati',
                signIn: 'Accedi',

                // Form labels
                emailLabel: 'Indirizzo Email',
                passwordLabel: 'Password',
                confirmPasswordLabel: 'Conferma Password',

                // Placeholders
                emailPlaceholder: 'Inserisci il tuo indirizzo email',
                passwordPlaceholder: 'Crea una password sicura',
                confirmPasswordPlaceholder: 'Conferma la tua password',
                signinPasswordPlaceholder: 'Inserisci la tua password',

                // Buttons
                createAccount: 'Crea Account',
                signInButton: 'Accedi',
                forgotPassword: 'Password dimenticata?',

                // Validation messages
                emailRequired: 'L\'email √® richiesta',
                emailInvalid: 'Per favore inserisci un indirizzo email valido',
                emailInUse: 'L\'indirizzo email √® gi√† in uso',
                emailNotFound: 'Nessun account trovato con questo indirizzo email',
                passwordRequired: 'La password √® richiesta',
                confirmPasswordRequired: 'Per favore conferma la tua password',
                passwordMismatch: 'Le password non corrispondono',
                passwordWeak: 'Debole',
                passwordFair: 'Discreta',
                passwordGood: 'Buona',
                passwordStrong: 'Forte',

                // Status messages
                verificationEmailSent: 'Account creato! Per favore controlla la tua email per verificare il tuo account.',
                emailNotVerified: 'Per favore verifica il tuo indirizzo email prima di accedere.',
                passwordResetSent: 'Email di reset password inviata. Per favore controlla la tua casella di posta.',
                signinSuccess: 'Accesso riuscito! Reindirizzamento...',

                // Error messages
                signupError: 'Errore nella creazione dell\'account. Per favore riprova.',
                signinError: 'Errore nell\'accesso. Per favore riprova.',
                passwordResetError: 'Errore nell\'invio dell\'email di reset password.',
                invalidCredentials: 'Email o password non valide',
                accountDisabled: 'Questo account √® stato disabilitato',
                tooManyRequests: 'Troppi tentativi falliti. Per favore riprova pi√π tardi'
            },
            pt: {
                // Language names
                english: 'English',
                spanish: 'Espa√±ol',
                french: 'Fran√ßais',
                german: 'Deutsch',
                italian: 'Italiano',
                portuguese: 'Portugu√™s',

                // Header
                signupTitle: 'Criar Conta',
                signupSubtitle: 'Junte-se ao SolTecSol e desbloqueie a gera√ß√£o de descri√ß√µes de produtos alimentada por IA',
                backToApp: 'Voltar ao App',

                // Navigation
                signUp: 'Cadastrar',
                signIn: 'Entrar',

                // Form labels
                emailLabel: 'Endere√ßo de Email',
                passwordLabel: 'Senha',
                confirmPasswordLabel: 'Confirmar Senha',

                // Placeholders
                emailPlaceholder: 'Digite seu endere√ßo de email',
                passwordPlaceholder: 'Crie uma senha forte',
                confirmPasswordPlaceholder: 'Confirme sua senha',
                signinPasswordPlaceholder: 'Digite sua senha',

                // Buttons
                createAccount: 'Criar Conta',
                signInButton: 'Entrar',
                forgotPassword: 'Esqueceu a senha?',

                // Validation messages
                emailRequired: 'Email √© obrigat√≥rio',
                emailInvalid: 'Por favor digite um endere√ßo de email v√°lido',
                emailInUse: 'Endere√ßo de email j√° est√° em uso',
                emailNotFound: 'Nenhuma conta encontrada com este endere√ßo de email',
                passwordRequired: 'Senha √© obrigat√≥ria',
                confirmPasswordRequired: 'Por favor confirme sua senha',
                passwordMismatch: 'Senhas n√£o coincidem',
                passwordWeak: 'Fraca',
                passwordFair: 'Razo√°vel',
                passwordGood: 'Boa',
                passwordStrong: 'Forte',

                // Status messages
                verificationEmailSent: 'Conta criada! Por favor verifique seu email para verificar sua conta.',
                emailNotVerified: 'Por favor verifique seu endere√ßo de email antes de entrar.',
                passwordResetSent: 'Email de redefini√ß√£o de senha enviado. Por favor verifique sua caixa de entrada.',
                signinSuccess: 'Login bem-sucedido! Redirecionando...',

                // Error messages
                signupError: 'Falha ao criar conta. Por favor tente novamente.',
                signinError: 'Falha ao entrar. Por favor tente novamente.',
                passwordResetError: 'Falha ao enviar email de redefini√ß√£o de senha.',
                invalidCredentials: 'Email ou senha inv√°lidos',
                accountDisabled: 'Esta conta foi desabilitada',
                tooManyRequests: 'Muitas tentativas falharam. Por favor tente novamente mais tarde'
            }
        };

        let currentLanguage = 'en';

        function updateTranslations(language = currentLanguage) {
            const elements = document.querySelectorAll('[data-translate]');
            const langData = translations[language] || translations.en;

            elements.forEach(element => {
                const key = element.getAttribute('data-translate');
                if (langData[key]) {
                    element.textContent = langData[key];
                }
            });

            // Update placeholders
            const placeholderElements = document.querySelectorAll('[data-translate-placeholder]');
            placeholderElements.forEach(element => {
                const key = element.getAttribute('data-translate-placeholder');
                if (langData[key]) {
                    element.placeholder = langData[key];
                }
            });
        }

        function setupLanguageSelector() {
            const languageSelect = document.getElementById('languageSelect');
            if (languageSelect) {
                languageSelect.addEventListener('change', (event) => {
                    currentLanguage = event.target.value;
                    updateTranslations(currentLanguage);
                    // Save language preference
                    localStorage.setItem('soltecsol_language', currentLanguage);
                });

                // Load saved language preference
                const savedLanguage = localStorage.getItem('soltecsol_language');
                if (savedLanguage && translations[savedLanguage]) {
                    currentLanguage = savedLanguage;
                    languageSelect.value = currentLanguage;
                    updateTranslations(currentLanguage);
                }
            }
        }

        // Enhanced error handling with user-friendly messages
        window.addEventListener('error', function(event) {
            console.error('Global error:', event.error);
            if (typeof showNotification === 'function') {
                showNotification('An unexpected error occurred. Please refresh the page.', 'error');
            }
        });

        window.addEventListener('unhandledrejection', function(event) {
            console.error('Unhandled promise rejection:', event.reason);
            if (typeof showNotification === 'function') {
                showNotification('An unexpected error occurred. Please try again.', 'error');
            }
        });

        // Initialize everything when DOM is ready and Firebase is available
        document.addEventListener('DOMContentLoaded', function() {
            // Setup language selector
            setupLanguageSelector();

            // Update translations
            updateTranslations();

            // Setup form event listeners
            const signupForm = document.getElementById('signupForm');
            const signupPassword = document.getElementById('signupPassword');

            if (signupForm) {
                signupForm.addEventListener('submit', handleSignUp);
            }

            if (signupPassword) {
                signupPassword.addEventListener('input', (e) => {
                    updatePasswordStrength(e.target.value);
                });
            }

            // Setup modal checkbox handlers
            setupTosCheckbox();
            setupDpaCheckbox();

            // Wait for Firebase to be ready
            if (window.firebaseAuth) {
                initializeInfrastructure();
            } else {
                window.addEventListener('firebaseReady', initializeInfrastructure);
            }
        });

        async function initializeInfrastructure() {
            try {
                console.log('Initializing signup page infrastructure...');

                // Initialize token management
                initializeTokenManager();

                // Update user info display
                await updateUserInfo();

                console.log('Signup page infrastructure initialized successfully');

            } catch (error) {
                console.error('Infrastructure initialization failed:', error);
                showNotification('Service initialization failed. Please refresh the page.', 'error');
            }
        }

        // SECURITY ENHANCEMENT: Secure URL validation function
        function getValidatedReturnUrl() {
            // Check secure sessionStorage first, then URL parameters
            let returnUrl = getSecureSessionData('soltecsol_auth_return_url');
            if (!returnUrl) {
                const urlParams = new URLSearchParams(window.location.search);
                returnUrl = urlParams.get('return_to') || urlParams.get('returnUrl');
            }

            // Default to app if no return URL
            returnUrl = returnUrl || 'https://app.soltecsol.com';

            // Enhanced security validation for return URLs
            try {
                // Decode URL first to handle encoded attacks
                const decodedUrl = decodeURIComponent(returnUrl);
                const url = new URL(decodedUrl);

                // Strict validation rules
                const allowedDomains = ['app.soltecsol.com', 'www.soltecsol.com', 'soltecsol.com', 'subscriptions.soltecsol.com', 'signup.soltecsol.com'];
                const isValidDomain = allowedDomains.includes(url.hostname);
                const isHttps = url.protocol === 'https:';
                const hasNoUserInfo = !url.username && !url.password;
                const isSafePath = !decodedUrl.includes('javascript:') && !decodedUrl.includes('data:') && !decodedUrl.includes('vbscript:');

                if (isValidDomain && isHttps && hasNoUserInfo && isSafePath) {
                    // Additional path validation - no directory traversal or suspicious patterns
                    const suspiciousPatterns = ['../', '.\\', '%2e%2e', '%5c', '\\'];
                    const hasSuspiciousPattern = suspiciousPatterns.some(pattern =>
                        decodedUrl.toLowerCase().includes(pattern)
                    );

                    if (!hasSuspiciousPattern) {
                        return decodedUrl;
                    }
                }

                console.warn('Invalid return URL blocked:', decodedUrl);
                return 'https://app.soltecsol.com';

            } catch (error) {
                console.warn('Return URL validation error:', error.message);
                return 'https://app.soltecsol.com';
            }
        }

        // SECURITY ENHANCEMENT: Secure sessionStorage management
        function setSecureSessionData(key, value) {
            try {
                // Validate key naming convention
                if (!key.startsWith('soltecsol_') || key.includes('<script') || key.includes('javascript:')) {
                    console.error('Invalid session key rejected:', key);
                    return false;
                }

                // Validate value content
                if (typeof value === 'string' && (value.includes('<script') || value.includes('javascript:') || value.includes('data:'))) {
                    console.error('Suspicious session value rejected');
                    return false;
                }

                // Store with expiration timestamp
                const data = {
                    value: value,
                    expires: Date.now() + (60 * 60 * 1000) // 1 hour
                };

                sessionStorage.setItem(key, JSON.stringify(data));
                return true;

            } catch (error) {
                console.error('Failed to set secure session data:', error);
                return false;
            }
        }

        function getSecureSessionData(key) {
            try {
                const stored = sessionStorage.getItem(key);
                if (!stored) return null;

                const data = JSON.parse(stored);

                // Check expiration
                if (Date.now() > data.expires) {
                    sessionStorage.removeItem(key);
                    return null;
                }

                return data.value;

            } catch (error) {
                console.error('Failed to get secure session data:', error);
                sessionStorage.removeItem(key); // Remove corrupted data
                return null;
            }
        }

        // Utility function to handle URL parameters securely
        function handleUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);

            // Handle email verification
            const verified = urlParams.get('verified');
            if (verified === 'true') {
                showNotification('Email verified successfully! You can now sign in.', 'success');
                // Clean up URL
                window.history.replaceState({}, document.title, window.location.pathname);
                // Switch to sign in tab
                document.querySelector('[data-tab="signin"]').click();
                return;
            }

            // SESSION 3C: Handle tab parameter for direct navigation - validate input
            const tabParam = urlParams.get('tab');
            if (tabParam && /^[a-z]+$/.test(tabParam) && ['signin', 'signup'].includes(tabParam)) {
                // Switch to specified tab if valid
                setTimeout(() => {
                    const tabButton = document.querySelector(`[data-tab="${tabParam}"]`);
                    if (tabButton) {
                        tabButton.click();
                    }
                }, 100); // Small delay to ensure tabs are initialized
            }

            // Store return URL securely after validation
            const returnUrl = urlParams.get('return_to') || urlParams.get('returnUrl');
            if (returnUrl) {
                // Pre-validate the URL before storing
                try {
                    const decodedUrl = decodeURIComponent(returnUrl);
                    const url = new URL(decodedUrl);
                    const allowedDomains = ['app.soltecsol.com', 'www.soltecsol.com', 'soltecsol.com', 'subscriptions.soltecsol.com', 'signup.soltecsol.com'];

                    if (allowedDomains.includes(url.hostname) && url.protocol === 'https:') {
                        setSecureSessionData('soltecsol_auth_return_url', decodedUrl);
                    } else {
                        console.warn('Invalid return URL parameter rejected:', decodedUrl);
                    }
                } catch (error) {
                    console.warn('Malformed return URL parameter rejected:', returnUrl);
                }
            }
        }

        // Handle URL parameters when page loads
        handleUrlParams();

    </script> -->
</body>
</html>