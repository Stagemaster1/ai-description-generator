<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - AI Description Generator</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 25%, #334155 50%, #475569 75%, #1e293b 100%);
            color: #334155;
            font-weight: bold;
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 95%;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: #e5e7eb;
            padding: 12px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 10px;
            position: relative;
            min-height: 70px;
        }
        
        .header-buttons {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
        }
        
        .header-buttons button {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-view-site {
            background: #10b981 !important;
            color: white !important;
            text-decoration: none;
            display: inline-block;
            border: none;
            cursor: pointer;
            font-weight: 600;
            border-radius: 8px;
        }
        
        .btn-view-site:hover {
            background: #059669 !important;
            text-decoration: none;
        }

        .login-form, .admin-panel {
            background: #e5e7eb;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .login-form {
            max-width: 400px;
            margin: 100px auto;
        }

        h1, h2 {
            color: #1e293b;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .password-fields {
            display: flex;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
        }

        .password-fields .form-group {
            flex: 1;
            margin-bottom: 0;
        }

        .btn-success {
            font-size: 14px;
            font-weight: 600;
            padding: 12px 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }

        input, select, button {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 16px;
        }

        /* Smaller password fields but keep full input capability */
        input[type="password"] {
            width: 300px;
            max-width: 100%;
        }

        button {
            background: #3b82f6;
            color: white;
            border: none;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: #2563eb;
        }

        .btn-danger {
            background: #ef4444;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-success {
            background: #10b981;
        }

        .btn-success:hover {
            background: #059669;
        }

        .actions {
            display: flex;
            flex-wrap: nowrap;
            gap: 8px;
            margin-bottom: 20px;
        }

        .actions button {
            flex: 1;
            font-size: 15px;
            padding: 10px 6px;
            white-space: nowrap;
        }

        .users-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: #e5e7eb;
        }

        .users-table th,
        .users-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e5e7eb;
            font-weight: bold;
        }

        .users-table th {
            background: #e5e7eb;
            font-weight: bold;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .status-free { background: #fee2e2; color: #991b1b; }
        .status-starter { background: #dbeafe; color: #1d4ed8; }
        .status-professional { background: #d1fae5; color: #047857; }
        .status-enterprise { background: #fef3c7; color: #92400e; }

        .user-actions {
            display: flex;
            gap: 8px;
        }

        .user-actions button {
            width: auto;
            padding: 8px 12px;
            font-size: 14px;
        }

        .notification {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .notification.success {
            background: #d1fae5;
            color: #047857;
            border: 1px solid #10b981;
        }

        .notification.error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #ef4444;
        }

        .stats {
            display: grid;
            grid-template-columns: 1.2fr 1fr 1fr 1fr;
            gap: 5px;
            margin-bottom: 8px;
        }

        .stat-card {
            background: #e5e7eb;
            padding: 10px 12px;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            height: 45px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #3b82f6;
            line-height: 1;
            margin: 0;
        }

        .stat-label {
            color: #64748b;
            font-size: 0.8rem;
            font-weight: bold;
            line-height: 1;
            margin: 2px 0 0 0;
        }

        .hidden {
            display: none;
        }

        /* Multi-column layout for better horizontal space usage */
        .admin-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 10px;
            width: 100%;
        }

        .admin-left-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-right-column {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .admin-panel {
            background: #e5e7eb;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            margin-bottom: 15px;
        }

        @media (max-width: 1200px) {
            .admin-content {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Login Form -->
        <div id="loginForm" class="login-form">
            <h1>üîê Admin Login</h1>
            <div class="form-group">
                <label for="adminPassword">Admin Password</label>
                <input type="password" id="adminPassword" placeholder="Enter admin password">
            </div>
            <button onclick="login()">Login</button>
        </div>

        <!-- Admin Panel (hidden initially) -->
        <div id="adminPanel" class="hidden">
            <div class="header">
                <h1>üõ†Ô∏è Admin Panel - AI Description Generator</h1>
                <p>Manage users, reset limits, and monitor system usage</p>
                <div class="header-buttons">
                    <a href="/" target="_blank" class="btn-view-site">üåç View Site</a>
                    <button onclick="logout()">Logout</button>
                </div>
            </div>

            <div id="notification" class="notification"></div>

            <!-- Stats -->
            <div class="stats">
                <div class="stat-card">
                    <div class="stat-value" id="totalUsers">-</div>
                    <div class="stat-label">Total Users</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="activeSubscriptions">-</div>
                    <div class="stat-label">Active Subscriptions</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="monthlyRevenue">$0</div>
                    <div class="stat-label">Monthly Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalGeneration">-</div>
                    <div class="stat-label">Total Generations</div>
                </div>
            </div>

            <!-- Revenue Analysis -->
            <div class="admin-panel" style="margin-top: 20px;">
                <h2>üìä Revenue vs OpenAI Cost Analysis</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="starterSubs">0</div>
                        <div class="stat-label">Starter ($19.99)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="professionalSubs">0</div>
                        <div class="stat-label">Professional ($49.99)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="enterpriseSubs">0</div>
                        <div class="stat-label">Enterprise ($99.99)</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="estimatedOpenAICost">$0</div>
                        <div class="stat-label">Est. OpenAI Cost/Month</div>
                    </div>
                </div>
                
                <div class="notification" id="revenueAlert" style="margin-top: 15px;">
                    <strong>üí° OpenAI Scaling Recommendation:</strong>
                    <div id="scalingAdvice">Loading analysis...</div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="admin-panel">
                <h2>Quick Actions</h2>
                <div class="actions">
                    <button onclick="refreshUsers()" class="btn-success">üîÑ Refresh Users</button>
                    <button onclick="resetAllUsage()">üìä Reset All Usage</button>
                    <button onclick="createTestUser()" class="btn-success">üë§ Create Test User</button>
                    <button onclick="addMissingSubscriber()" class="btn-success">‚ûï Add Missing Subscriber</button>
                    <button onclick="manualUnlock()" class="btn-success">üîì Manual Unlock</button>
                    <button onclick="testWebhook()" class="btn-success">üß™ Test Webhook (Safe)</button>
                    <button onclick="testNotionToken()" class="btn-success">üß™ Test Notion Token</button>
                    <button onclick="testDirectNotion()" class="btn-success">üéØ Test Direct Notion</button>
                    <button onclick="setupNotionDatabase()" class="btn-success">üìã Create Notion Database</button>
                    <button onclick="exportUsers()">üìÑ Export Data</button>
                </div>

                <!-- Individual User Management -->
                <h2>User Management</h2>
                <div class="form-group">
                    <label for="userEmail">User Email/ID</label>
                    <input type="text" id="userEmail" placeholder="Enter user email or ID">
                </div>
                <div class="actions">
                    <button onclick="resetUserUsage()">Reset Usage</button>
                    <button onclick="resetUserSubscription()">Reset Subscription</button>
                    <button onclick="deleteUser()" class="btn-danger" disabled style="opacity: 0.5; cursor: not-allowed;" title="Use delete buttons in user table instead">Delete User (Disabled)</button>
                </div>

                    <!-- Admin Settings -->
                    <div class="admin-panel">
                        <h2>Admin Settings</h2>
                <div class="password-fields">
                    <div class="form-group">
                        <label for="currentPassword">Current Password</label>
                        <input type="password" id="currentPassword" placeholder="Enter current admin password">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">New Password</label>
                        <input type="password" id="newPassword" placeholder="Enter new admin password">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Confirm New Password</label>
                        <input type="password" id="confirmPassword" placeholder="Confirm new admin password">
                    </div>
                </div>
                <div class="actions">
                    <button onclick="changeAdminPassword()" class="btn-success">üîí Change Password</button>
                </div>
                </div>

            <!-- Users Table -->
            <div class="admin-panel">
                        <h2>All Users</h2>
                <table class="users-table" id="usersTable">
                    <thead>
                        <tr>
                            <th>Email/ID</th>
                            <th>Plan</th>
                            <th>Usage</th>
                            <th>Status</th>
                            <th>Last Active</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <tr>
                            <td colspan="6" style="text-align: center; padding: 40px;">
                                Click "Refresh Users" to load user data
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
    </div>

    <script>
        let adminPassword = '';
        let users = [];

        function login() {
            const password = document.getElementById('adminPassword').value;
            if (!password) {
                showNotification('Please enter password', 'error');
                return;
            }

            adminPassword = password;
            
            // Test password by trying to get users
            refreshUsers().then(() => {
                document.getElementById('loginForm').classList.add('hidden');
                document.getElementById('adminPanel').classList.remove('hidden');
                showNotification('Login successful', 'success');
            }).catch(() => {
                showNotification('Invalid password', 'error');
                adminPassword = '';
            });
        }

        function logout() {
            adminPassword = '';
            document.getElementById('adminPanel').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
            document.getElementById('adminPassword').value = '';
        }

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        async function apiCall(action, data = {}) {
            const response = await fetch('/.netlify/functions/admin', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action,
                    password: adminPassword,
                    ...data
                })
            });

            if (!response.ok) {
                throw new Error(`API call failed: ${response.status}`);
            }

            return response.json();
        }

        async function refreshUsers() {
            try {
                const result = await apiCall('get_all_users');
                users = result.users || [];
                updateStats();
                renderUsersTable();
                showNotification(`Loaded ${users.length} users`, 'success');
            } catch (error) {
                showNotification('Failed to load users: ' + error.message, 'error');
                throw error;
            }
        }

        function updateStats() {
            // Basic stats
            document.getElementById('totalUsers').textContent = users.length;
            const activeSubscriptions = users.filter(u => u.isSubscribed).length;
            document.getElementById('activeSubscriptions').textContent = activeSubscriptions;
            document.getElementById('totalGeneration').textContent = 
                users.reduce((sum, u) => sum + (u.monthlyUsage || 0), 0);

            // Revenue analysis
            const starterSubs = users.filter(u => u.subscriptionType === 'starter').length;
            const professionalSubs = users.filter(u => u.subscriptionType === 'professional').length;
            const enterpriseSubs = users.filter(u => u.subscriptionType === 'enterprise').length;
            
            const monthlyRevenue = (starterSubs * 19.99) + (professionalSubs * 49.99) + (enterpriseSubs * 99.99);
            
            // Estimate OpenAI costs (rough calculation)
            const totalDescriptionsPerMonth = (starterSubs * 50) + (professionalSubs * 200) + (enterpriseSubs * 500);
            const estimatedOpenAICost = (totalDescriptionsPerMonth * 0.03); // ~$0.03 per description
            
            // Update revenue stats
            document.getElementById('starterSubs').textContent = starterSubs;
            document.getElementById('professionalSubs').textContent = professionalSubs;
            document.getElementById('enterpriseSubs').textContent = enterpriseSubs;
            document.getElementById('monthlyRevenue').textContent = '$' + monthlyRevenue.toFixed(2);
            document.getElementById('estimatedOpenAICost').textContent = '$' + estimatedOpenAICost.toFixed(2);
            
            // Scaling recommendations
            updateScalingAdvice(monthlyRevenue, estimatedOpenAICost, activeSubscriptions);
        }

        function updateScalingAdvice(revenue, estimatedCost, subscribers) {
            const revenueAlert = document.getElementById('revenueAlert');
            const scalingAdvice = document.getElementById('scalingAdvice');
            
            let advice = '';
            let alertClass = 'success';
            
            if (subscribers === 0) {
                advice = 'No active subscriptions yet. Current OpenAI free tier should be sufficient for testing.';
                alertClass = 'success';
            } else if (revenue < 100) {
                advice = `Revenue: $${revenue.toFixed(2)}/month. Suggested OpenAI limit: $50/month (safe for early growth).`;
                alertClass = 'success';
            } else if (revenue < 500) {
                advice = `Revenue: $${revenue.toFixed(2)}/month. Consider increasing OpenAI limit to $${Math.round(estimatedCost * 3)}/month (3x safety margin).`;
                alertClass = 'success';
            } else if (revenue < 1000) {
                advice = `Revenue: $${revenue.toFixed(2)}/month. Recommended OpenAI limit: $${Math.round(estimatedCost * 2.5)}/month. You're scaling well! üöÄ`;
                alertClass = 'success';
            } else {
                advice = `Revenue: $${revenue.toFixed(2)}/month. You're crushing it! üí∞ Consider OpenAI limit: $${Math.round(estimatedCost * 2)}/month and potentially upgrading to OpenAI's enterprise pricing.`;
                alertClass = 'success';
            }
            
            // Profit margin check
            const profit = revenue - estimatedCost;
            const profitMargin = revenue > 0 ? (profit / revenue) * 100 : 0;
            
            if (profitMargin > 80) {
                advice += ` | Profit margin: ${profitMargin.toFixed(1)}% - Excellent! üí™`;
            } else if (profitMargin > 60) {
                advice += ` | Profit margin: ${profitMargin.toFixed(1)}% - Healthy business! üëç`;
            } else if (profitMargin > 40) {
                advice += ` | Profit margin: ${profitMargin.toFixed(1)}% - Good, monitor costs.`;
            } else if (profitMargin > 0) {
                advice += ` | Profit margin: ${profitMargin.toFixed(1)}% - Watch OpenAI usage carefully.`;
                alertClass = 'error';
            } else if (revenue > 0) {
                advice += ` | ‚ö†Ô∏è Negative margin! Costs exceed revenue - check for unusual usage.`;
                alertClass = 'error';
            }
            
            scalingAdvice.textContent = advice;
            revenueAlert.className = `notification ${alertClass}`;
            revenueAlert.style.display = 'block';
        }

        function updateUserDropdown(userList) {
            const dropdown = document.getElementById('userEmail');
            dropdown.innerHTML = '<option value="">Select a user...</option>';
            
            userList.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = `${user.email || user.id} (${user.subscriptionType || 'free'})`;
                dropdown.appendChild(option);
            });
        }

        function renderUsersTable() {
            const tbody = document.getElementById('usersTableBody');
            
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" style="text-align: center;">No users found</td></tr>';
                updateUserDropdown([]);
                return;
            }

            updateUserDropdown(users);
            tbody.innerHTML = users.map(user => {
                const isUnlocked = user.manuallyUnlocked || user.subscriptionType === 'unlocked';
                const statusText = isUnlocked ? 'üîì Unlocked' : (user.isSubscribed ? '‚úÖ Active' : '‚ùå Inactive');
                
                return `
                <tr>
                    <td>${user.email || user.id}</td>
                    <td>
                        <span class="status-badge status-${user.subscriptionType || 'free'}">
                            ${(user.subscriptionType || 'free').toUpperCase()}
                        </span>
                    </td>
                    <td>${user.monthlyUsage || 0} / ${user.maxUsage || 5}</td>
                    <td>${statusText}</td>
                    <td>${user.lastActive ? new Date(user.lastActive).toLocaleDateString() : '-'}</td>
                    <td class="user-actions">
                        <button onclick="resetUserUsageById('${user.id}')" title="Reset Usage">üîÑ</button>
                        ${isUnlocked 
                            ? `<button onclick="lockUser('${user.id}')" title="Lock User" style="background: #ef4444;">üîí</button>`
                            : `<button onclick="unlockUser('${user.id}')" title="Unlock User" style="background: #10b981;">üîì</button>`
                        }
                        <button onclick="resetUserSubscriptionById('${user.id}')" title="Reset Sub">üìä</button>
                        <button onclick="deleteUserById('${user.id}')" class="btn-danger" title="Delete">üóëÔ∏è</button>
                    </td>
                </tr>`;
            }).join('');
        }

        async function resetUserUsage() {
            const userId = document.getElementById('userEmail').value.trim();
            if (!userId) {
                showNotification('Please enter user email/ID', 'error');
                return;
            }
            await resetUserUsageById(userId);
        }

        async function resetUserUsageById(userId) {
            try {
                await apiCall('reset_usage', { userId });
                showNotification(`Usage reset for ${userId}`, 'success');
                refreshUsers();
            } catch (error) {
                showNotification('Failed to reset usage: ' + error.message, 'error');
            }
        }

        async function resetUserSubscription() {
            const userId = document.getElementById('userEmail').value.trim();
            if (!userId) {
                showNotification('Please enter user email/ID', 'error');
                return;
            }
            await resetUserSubscriptionById(userId);
        }

        async function resetUserSubscriptionById(userId) {
            try {
                await apiCall('reset_subscription', { userId });
                showNotification(`Subscription reset for ${userId}`, 'success');
                refreshUsers();
            } catch (error) {
                showNotification('Failed to reset subscription: ' + error.message, 'error');
            }
        }

        async function deleteUser() {
            const userId = document.getElementById('userEmail').value.trim();
            if (!userId) {
                showNotification('Please enter user email/ID', 'error');
                return;
            }
            
            if (!confirm(`Are you sure you want to delete user: ${userId}?`)) {
                return;
            }
            
            await deleteUserById(userId);
        }

        async function deleteUserById(userId) {
            try {
                await apiCall('delete_user', { userId });
                showNotification(`User ${userId} deleted`, 'success');
                refreshUsers();
            } catch (error) {
                showNotification('Failed to delete user: ' + error.message, 'error');
            }
        }

        async function createTestUser() {
            try {
                const result = await apiCall('create_test_user', {
                    email: `test-${Date.now()}@example.com`
                });
                showNotification(`Test user created: ${result.user.email}`, 'success');
                refreshUsers();
            } catch (error) {
                showNotification('Failed to create test user: ' + error.message, 'error');
            }
        }

        async function resetAllUsage() {
            if (!confirm('Are you sure you want to reset usage for ALL users?')) {
                return;
            }
            
            try {
                const result = await apiCall('reset_all_usage');
                showNotification(`All user usage reset (${result.resetCount} users)`, 'success');
                refreshUsers();
            } catch (error) {
                showNotification('Failed to reset all usage: ' + error.message, 'error');
            }
        }

        function exportUsers() {
            const csv = 'Email/ID,Plan,Usage,Max Usage,Subscribed,Last Active\n' +
                users.map(u => `${u.email || u.id},${u.subscriptionType || 'free'},${u.monthlyUsage || 0},${u.maxUsage || 5},${u.isSubscribed || false},${u.lastActive || ''}`).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `users-export-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            
            showNotification('Users exported to CSV', 'success');
        }

        async function addMissingSubscriber() {
            const email = prompt('Enter subscriber email:');
            if (!email) return;
            
            const plan = prompt('Enter plan type (starter/professional/enterprise):', 'starter');
            if (!plan) return;
            
            const planLimits = { starter: 50, professional: 200, enterprise: 999999 };
            const maxUsage = planLimits[plan] || 50;
            
            try {
                const result = await apiCall('manual_add_user', {
                    userData: {
                        email: email.trim(),
                        subscriptionType: plan.toLowerCase(),
                        maxUsage: maxUsage,
                        monthlyUsage: 0,
                        isSubscribed: true,
                        subscriptionId: `manual-${Date.now()}`
                    }
                });
                
                if (result.success) {
                    showNotification(`Subscriber ${email} added successfully!`, 'success');
                    refreshUsers(); // Refresh the user list
                } else {
                    showNotification('Failed to add subscriber: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to add subscriber: ' + error.message, 'error');
            }
        }

        async function manualUnlock() {
            const email = prompt('Enter email to unlock with unlimited access:');
            if (!email || !email.includes('@')) {
                showNotification('Please enter a valid email address', 'error');
                return;
            }
            
            const confirm = window.confirm(`Give ${email} unlimited access for free?\n\nThis is for beta testers and special cases.`);
            if (!confirm) return;
            
            try {
                const result = await apiCall('manual_unlock', {
                    userData: {
                        email: email.trim()
                    }
                });
                
                if (result.success) {
                    showNotification(`${email} unlocked with unlimited access!`, 'success');
                    refreshUsers(); // Refresh the user list
                } else {
                    showNotification('Failed to unlock user: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to unlock user: ' + error.message, 'error');
            }
        }

        async function unlockUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const confirm = window.confirm(`Unlock ${user.email || user.id} for unlimited access?`);
            if (!confirm) return;
            
            try {
                const result = await apiCall('update_user', {
                    userId: userId,
                    userData: {
                        manuallyUnlocked: true,
                        maxUsage: 999999,
                        subscriptionType: 'unlocked',
                        originalSubscriptionType: user.subscriptionType || 'free' // Store original plan
                    }
                });
                
                if (result.success) {
                    showNotification(`User unlocked successfully!`, 'success');
                    refreshUsers();
                } else {
                    showNotification('Failed to unlock user: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to unlock user: ' + error.message, 'error');
            }
        }

        async function lockUser(userId) {
            const user = users.find(u => u.id === userId);
            if (!user) return;
            
            const confirm = window.confirm(`Lock ${user.email || user.id} back to their original plan?`);
            if (!confirm) return;
            
            // Use original subscription type or current if no original stored
            const originalPlan = user.originalSubscriptionType || user.subscriptionType;
            const planLimits = { starter: 50, professional: 200, enterprise: 999999, free: 5 };
            const maxUsage = planLimits[originalPlan] || 5;
            
            try {
                const result = await apiCall('update_user', {
                    userId: userId,
                    userData: {
                        manuallyUnlocked: false,
                        maxUsage: maxUsage,
                        subscriptionType: originalPlan === 'unlocked' ? 'free' : originalPlan
                    }
                });
                
                if (result.success) {
                    showNotification(`User locked back to ${originalPlan} plan (${maxUsage} limit)!`, 'success');
                    refreshUsers();
                } else {
                    showNotification('Failed to lock user: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to lock user: ' + error.message, 'error');
            }
        }

        async function updateUserUsage(userId, newUsage) {
            try {
                const result = await apiCall('update_user', {
                    userId: userId,
                    userData: {
                        monthlyUsage: parseInt(newUsage) || 0
                    }
                });
                
                if (result.success) {
                    showNotification(`Usage updated to ${newUsage}`, 'success');
                } else {
                    showNotification('Failed to update usage: ' + result.message, 'error');
                }
            } catch (error) {
                showNotification('Failed to update usage: ' + error.message, 'error');
            }
        }


        async function testDirectNotion() {
            try {
                const response = await fetch('/.netlify/functions/notion-direct-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Direct Notion test SUCCESS! Page ID: ' + result.pageId, 'success');
                } else {
                    showNotification('Direct test failed: ' + (result.error || 'Unknown error'), 'error');
                    console.log('Full error details:', JSON.stringify(result, null, 2));
                }
            } catch (error) {
                showNotification('Direct test error: ' + error.message, 'error');
            }
        }

        async function testNotionToken() {
            try {
                const response = await fetch('/.netlify/functions/notion-test', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification('Notion token test: ' + result.message + ' User: ' + result.user, 'success');
                } else {
                    showNotification('Token test failed: ' + (result.error || 'Unknown error'), 'error');
                    console.log('Full error:', result);
                }
            } catch (error) {
                showNotification('Token test error: ' + error.message, 'error');
            }
        }

        async function setupNotionDatabase() {
            if (!confirm('Create the Notion subscriber database in your SolTecSol HQ page?')) {
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/notion-setup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`Notion database created! Database ID: ${result.databaseId.slice(0, 8)}...`, 'success');
                    console.log('Add this to Netlify environment variables:');
                    console.log('NOTION_DATABASE_ID =', result.databaseId);
                } else {
                    showNotification('Database creation failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Setup error: ' + error.message, 'error');
            }
        }

        async function testWebhook() {
            if (!confirm('Test the subscription webhook? This will create a test subscriber safely without affecting PayPal.')) {
                return;
            }
            
            try {
                const response = await fetch('/.netlify/functions/subscription-webhook', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'test_subscription',
                        email: 'test-subscriber@example.com',
                        planName: 'starter',
                        subscriptionId: 'test-webhook-' + Date.now()
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showNotification(`Webhook test successful! User created: ${result.userCreated}, Notion notified: ${result.notionNotified}`, 'success');
                    refreshUsers(); // Refresh to show the new test user
                } else {
                    showNotification('Webhook test failed: ' + (result.error || 'Unknown error'), 'error');
                }
            } catch (error) {
                showNotification('Webhook test error: ' + error.message, 'error');
            }
        }

        async function changeAdminPassword() {
            const currentPassword = document.getElementById('currentPassword').value.trim();
            const newPassword = document.getElementById('newPassword').value.trim();
            const confirmPassword = document.getElementById('confirmPassword').value.trim();

            if (!currentPassword || !newPassword || !confirmPassword) {
                showNotification('Please fill in all password fields', 'error');
                return;
            }

            if (currentPassword !== adminPassword) {
                showNotification('Current password is incorrect', 'error');
                return;
            }

            if (newPassword.length < 8) {
                showNotification('New password must be at least 8 characters long', 'error');
                return;
            }

            if (newPassword !== confirmPassword) {
                showNotification('New passwords do not match', 'error');
                return;
            }

            try {
                await apiCall('change_password', { 
                    currentPassword,
                    newPassword 
                });
                
                adminPassword = newPassword;
                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';
                
                showNotification('Admin password changed successfully', 'success');
            } catch (error) {
                showNotification('Failed to change password: ' + error.message, 'error');
            }
        }
    </script>
</body>
</html>