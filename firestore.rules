rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Users can only access their own user document
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
      
      // Additional security checks for write operations
      allow write: if request.auth != null && 
        request.auth.uid == userId &&
        request.auth.token.email_verified == true &&
        validateUserData(request.resource.data);
    }
    
    // Admin access requires proper authentication and admin role
    match /admin_logs/{document} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true &&
        request.auth.token.email_verified == true;
    }
    
    // Deleted users archive - admin access only
    match /deleted_users/{document} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true &&
        request.auth.token.email_verified == true;
    }
    
    // Public data - read-only access for authenticated users
    match /public/{document=**} {
      allow read: if request.auth != null;
      allow write: if false; // No writes allowed to public data
    }
    
    // Analytics data - admin access only
    match /analytics/{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true &&
        request.auth.token.email_verified == true;
    }
    
    // Rate limiting logs - admin access only
    match /rate_limits/{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true &&
        request.auth.token.email_verified == true;
    }
    
    // System logs - admin access only
    match /system_logs/{document=**} {
      allow read, write: if request.auth != null && 
        request.auth.token.admin == true &&
        request.auth.token.email_verified == true;
    }
    
    // Deny access to all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
  
  // Helper function to validate user data structure
  function validateUserData(data) {
    return data.keys().hasAll(['email', 'subscriptionType', 'monthlyUsage', 'maxUsage']) &&
           data.email is string &&
           data.subscriptionType in ['free', 'starter', 'professional', 'enterprise'] &&
           data.monthlyUsage is number &&
           data.maxUsage is number &&
           data.monthlyUsage >= 0 &&
           data.maxUsage >= 0;
  }
  
  // Helper function to check if user is admin
  function isAdmin() {
    return request.auth != null && 
           request.auth.token.admin == true &&
           request.auth.token.email_verified == true;
  }
  
  // Helper function to check if user owns the resource
  function isOwner(userId) {
    return request.auth != null && 
           request.auth.uid == userId &&
           request.auth.token.email_verified == true;
  }
}